<!DOCTYPE html>
<html>
<head>
  <title>Emotion Recognition Study</title>
  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script> <!-- For DataPipe -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
</head>
<body>
  <script>

    const jsPsych = initJsPsych({
      show_progress_bar: true,
      override_safe_mode: true,
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    const timeline = [];

    const instructions = {
      type: jsPsychInstructions,
      pages: [
        '<h1>Welcome to the emotion recognition study!</h1>',
        '<p>You will hear speech clips in different languages.</p>',
        '<p>You will hear each clip once. Judge the speaker\'s emotion.</p>',
        '<p>If unsure, make your best guess!</p>',
        '<p>Press "Next" to begin.</p>'
      ],
      show_clickable_nav: true
    };
    timeline.push(instructions);

    const audioFiles = [
      'stim/test_stim/AESDD_anger_a20 (6).wav',
      'stim/test_stim/AESDD_happy_h02 (6).wav',
      'stim/test_stim/CaFE_anger_notintense_12-C-1-6.wav',
      'stim/test_stim/CaFE_Sad_notintense_01-T-1-1.wav',
      'stim/test_stim/JVNV_F2_sad_regular_60.wav',
      'stim/test_stim/JVNV_happy_M1_happy_regular_01.wav',
      'stim/test_stim/THAI_frustrated_s001_clip_actor002_script1_1_5a.flac',
      'stim/test_stim/THAI_happy_s005_clip_actor010_script2_2_3a.flac'
    ];

    const preload = {
      type: jsPsychPreload,
      audio: audioFiles
    };
    timeline.push(preload);

    const emotions = ['Happy', 'Sad', 'Angry', 'Frustrated', 'Fear', 'Disgust', 'Neutral'];

    // Main trials
    audioFiles.forEach(function(audioFile) {

      const playAudio = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p>Click the button below to listen to the audio.</p>',
        choices: ['Play Audio'],
        on_start: function(trial) {
          trial.response_ends_trial = false;
        },
        on_load: function() {
          const button = document.querySelector('.jspsych-btn');
          button.addEventListener('click', async () => {
            button.disabled = true; // Prevent double-click
            const context = jsPsych.pluginAPI.audioContext();
            const audioBuffer = await jsPsych.pluginAPI.getAudioBuffer(audioFile);
            const source = context.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(context.destination);
            source.start();
            source.onended = () => {
              jsPsych.finishTrial();
            };
          });
        },
        data: {stimulus_file: audioFile}
      };

      const emotionChoice = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p>Which emotion did the speaker express?</p>',
        choices: emotions,
        margin_vertical: '20px', // Add space between buttons
        button_html: '<button class="jspsych-btn" style="margin: 10px;">%choice%</button>',
        data: {stimulus_file: audioFile}
      };

      timeline.push(playAudio);
      timeline.push(emotionChoice);
    });

    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "eSR841l7tfeH",
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    const completion = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<h2>Thank you!</h2><p>The experiment is complete.</p>',
      choices: ['Finish']
    };
    timeline.push(completion);

    jsPsych.run(timeline);

  </script>
</body>
</html>
