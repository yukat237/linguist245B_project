<!DOCTYPE html>
<html>
<head>
  <title>Emotion Recognition Study</title>
  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script> <!-- For DataPipe -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
</head>
<body>
  <script>

    const jsPsych = initJsPsych({
      show_progress_bar: true,
      override_safe_mode: true,
    });

    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    const timeline = [];

    const instructions = {
      type: jsPsychInstructions,
      pages: [
        '<h1>Welcome to the emotion recognition test!</h1>',
        '<p>Find out your vocal emotion recognition ability!</p>',
        '<p>In this test, you will hear speech clips in different languages.</p>',
        '<p>You will hear each clip once. Judge the speaker\'s emotion.</p>',
        '<p>If unsure, just make your best guess!</p>',
        '<p>In the end, we will give you a score of how accurate you were, as well as how much time you spent.</p>',
        '<p>See if you can do better than native speakers of each language! </p>',
        '<p> Good luck! Press "Next" to begin. </p>'
      ],
      show_clickable_nav: true
    };
    timeline.push(instructions);

    let audioFiles = [
    "stim/test_stim2/jp_surprise__F2_surprise_regular_03_ext.wav",
    "stim/test_stim2/jp_sad__F2_sad_regular_02_ext.wav",
    "stim/test_stim2/jp_happy__F1_happy_regular_01_ext.wav",
    "stim/test_stim2/jp_fear__M2_fear_regular_01_ext.wav",
    "stim/test_stim2/jp_angry__M1_anger_regular_03_ext.wav",
    "stim/test_stim2/greek_sad__s12 (2).wav",
    "stim/test_stim2/greek_happy__h10 (1).wav",
    "stim/test_stim2/greek_fear__f12 (4).wav",
    "stim/test_stim2/greek_angry__a14 (3).wav",
    "stim/test_stim2/french_surprise__10-S-2-4.wav",
    "stim/test_stim2/french_sad__03-T-2-3.wav",
    "stim/test_stim2/french_neutral__08-N-1-2.wav",
    "stim/test_stim2/french_happy__03-J-2-2.wav",
    "stim/test_stim2/french_fear__05-P-2-2.wav",
    "stim/test_stim2/french_angry__01-C-2-4.wav",
    "stim/test_stim2/thai_angry__s008_clip_actor016_script3_2_2b.wav",
    "stim/test_stim2/thai_happy__s001_clip_actor002_script1_2_3b.wav",
    "stim/test_stim2/thai_neutral__s013_clip_actor026_script3_2_1b.wav",
    "stim/test_stim2/thai_sad__s001_clip_actor002_script2_2_4b.wav"
  ];

  // shuffle audios for every run
  audioFiles = jsPsych.randomization.shuffle(audioFiles);

    const preload = {
      type: jsPsychPreload,
      audio: audioFiles
    };
    timeline.push(preload);

    const emotions = ['Happy', 'Sad', 'Angry', 'Fear', 'Surprise', 'Neutral'];

    // Main trials
    audioFiles.forEach(function(audioFile) {
      //parse to get lang & corr emotions
      const base = audioFile.split('/').pop();                     // e.g. "jp_surprise__F2_â€¦"
      const [lang, emo] = base.split('__')[0].split('_');          // ["jp","surprise"]
      const correctEmotion = emo.charAt(0).toUpperCase() + emo.slice(1);


      const playAudio = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p>Click the button below to listen to the audio.</p>',
        choices: ['Play Audio'],
        on_start: function(trial) {
          trial.response_ends_trial = false;
        },
        on_load: function() {
          const button = document.querySelector('.jspsych-btn');
          button.addEventListener('click', async () => {
            button.disabled = true; // Prevent double-click
            const context = jsPsych.pluginAPI.audioContext();
            const audioBuffer = await jsPsych.pluginAPI.getAudioBuffer(audioFile);
            const source = context.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(context.destination);
            source.start();
            source.onended = () => {
              jsPsych.finishTrial();
            };
          });
        },
        data: {stimulus_file: audioFile}
      };

      const emotionChoice = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p>Which emotion did the speaker express?</p>',
        choices: emotions,
        margin_vertical: '20px',
        button_html: '<button class="jspsych-btn" style="margin: 10px;">%choice%</button>',
        data: {
          stimulus_file: audioFile,
          language: lang,
          correct_response: correctEmotion,
          trial_part: 'choice'
        },
        on_finish: function(data) {
          const chosen = emotions[data.response];
          data.correct = chosen === data.correct_response;
        }
      };

      timeline.push(playAudio, emotionChoice);
    });

    const summary = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        const all = jsPsych.data.get().filter({trial_part:'choice'});
        const total = all.count(),
              correct = all.filter({correct:true}).count();
        const langs = [...new Set(all.values().map(d=>d.language))];
        let html = `<h2>Your Results</h2>
                    <p><strong>Overall:</strong> ${correct}/${total} correct 
                      (${Math.round(correct/total*100)}%)</p>`;

        langs.forEach(lang=>{
          const subset = all.filter({language:lang});
          const t = subset.count(),
                c = subset.filter({correct:true}).count();
          html += `<p><strong>${lang.toUpperCase()}:</strong> ${c}/${t} correct 
                    (${Math.round(c/t*100)}%)</p>`;
        });

        return html + '<p>Press Continue to finish.</p>';
      },
      choices: ['Continue']
    };

    timeline.push(summary);




    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: subject_id,
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    const completion = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<h2>Thank you!</h2><p>The study is complete.</p>',
      choices: ['Finish']
    };
    timeline.push(completion);

    jsPsych.run(timeline);

  </script>
</body>
</html>